name: Backoffice - Build (auto) + Deploy to DigitalOcean (manual)

on:
  push:
    branches: ["main"]

  workflow_dispatch:
    inputs:
      tag:
        description: "Image tag to deploy (latest o sha-<commit>)"
        required: false
        default: "latest"

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}     # joseluismuzikant/inmo24x7-backoffice
  CONTAINER_NAME: inmo24x7-backoffice
  HOST_PORT: "3001"                        # puerto local en el droplet
  CONTAINER_PORT: "80"                     # el container expone 80 (Caddy interno) :contentReference[oaicite:1]{index=1}

jobs:
  build:
    name: Build & Push to GHCR
    if: github.event_name == 'push'
    runs-on: ubuntu-latest
    environment: prod
    permissions:
      contents: read
      packages: write

    steps:
      - uses: actions/checkout@v4

      - uses: docker/setup-buildx-action@v3

      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ github.token }}

      - name: Build & Push
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:sha-${{ github.sha }}
          build-args: |
            VITE_SUPABASE_URL=${{ vars.VITE_SUPABASE_URL }}
            VITE_SUPABASE_ANON_KEY=${{ vars.VITE_SUPABASE_ANON_KEY }}
            VITE_API_URL=${{ vars.VITE_API_URL }}
            VITE_USE_SUPABASE_AUTH=${{ vars.VITE_USE_SUPABASE_AUTH }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  deploy:
    name: Deploy to DigitalOcean (manual)
    if: github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    environment: prod
    permissions:
      contents: read
      packages: read

    steps:
      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.DIGITALOCEAN_HOST }}
          username: ${{ secrets.DIGITALOCEAN_USERNAME }}   # root
          key: ${{ secrets.DIGITALOCEAN_SSH_KEY }}
          script: |
            set -euo pipefail

            TAG="${{ inputs.tag }}"
            IMAGE="${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${TAG}"
            echo "Deploying ${IMAGE}"

            echo "${{ secrets.GHCR_PAT }}" | docker login ghcr.io -u "${{ github.repository_owner }}" --password-stdin
            docker pull "${IMAGE}"

            docker stop "${{ env.CONTAINER_NAME }}" || true
            docker rm "${{ env.CONTAINER_NAME }}" || true

            # IMPORTANTE: bind solo en localhost para no exponer el puerto
            docker run -d \
              --name "${{ env.CONTAINER_NAME }}" \
              --restart unless-stopped \
              -p "127.0.0.1:${{ env.HOST_PORT }}:${{ env.CONTAINER_PORT }}" \
              "${IMAGE}"

            docker image prune -f
            docker ps --filter "name=${{ env.CONTAINER_NAME }}"
